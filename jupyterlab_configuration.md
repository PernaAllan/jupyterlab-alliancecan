# Accessing a Computing Cluster and Setting Up JupyterLab

This tutorial provides step-by-step instructions for accessing a computing cluster, creating a virtual Python environment, installing JupyterLab, and using it interactively from your personal computer. This tutorial was based on [Advanced Jupyter configuration](https://docs.alliancecan.ca/wiki/Advanced_Jupyter_configuration#Python_kernel ). Always check it for more instructions. 

While this guide uses the user *aperna* and the cluster *narval* as examples, you should replace these with your own username and cluster name. Always refer to your institution's documentation for specific details.

## Part 1: Accessing the Cluster

To connect to a computing cluster, you need to use a terminal application. On Windows, you can use **PowerShell**. On macOS and Linux, the built-in terminal works perfectly.

### Step 1: Open the Terminal
- **Windows:** Press `Windows + R`, type `powershell`, and hit `Enter`.
- **macOS/Linux:** Open the terminal from the applications menu or use `Ctrl + Alt + T` (Linux).

### Step 2: Connect to the Cluster
Use the following command, replacing `your_username` and `cluster_address` with your specific credentials and cluster address:

<div style="background-color: black; color: black; padding: 3px; border-radius: 0px;">
<pre>
ssh your_username@cluster_address
</pre>
</div>

For example, if your username is aperna and the cluster is narval.computecanada.ca:

<div style="background-color: black; color: white; padding: 3px; border-radius: 0px;">
<pre>
ssh aperna@narval.computecanada.ca
</pre>
</div>

### Step 3: Authenticate

After entering the `ssh` command, you will be prompted to enter your password:


- **Password:** Type your password carefully (no characters will appear as you type, for security reasons). Press `Enter` when done.
- **Two-Factor Authentication (2FA):** If enabled, you will also need to enter a code generated by the **Duo Mobile** app or another authentication tool.






## Part 2: Creating a virtual environment

After connecting to the cluster, you are typically placed in your home directory. To verify your current location, you can use the command `pwd`. The output should display a path like `/home/your_username`.

To install JupyterLab on the cluster, it's essential to create an isolated Python environment. This ensures that package installations do not interfere with system-wide configurations. It's best practice to set up the virtual environment in your home directory.

### Step 1: Load the Python Module
First, load an appropriate Python module. You can use the default version or choose a specific one. To check available versions, run `module avail python`.

For this guide, we'll load the default Python module:
<div style="background-color: black; color: white; padding: 3px; border-radius: 0px; font-family: monospace;">
<pre>
module load python
</pre>
</div>

### Step 2: Create a Python Virtual Environment
Now, create the virtual environment. Here, `jupyter_py3` is a suggested name, but you can choose any identifier that suits your workflow:
<div style="background-color: black; color: white; padding: 3px; border-radius: 0px; font-family: monospace;">
<pre>
virtualenv --no-download $HOME/jupyter_py3
</pre>
</div>
<br>

- `virtualenv`: Tool for creating isolated Python environments.
- `--no-download`: Ensures that the environment is built using pre-installed packages, avoiding external downloads.
- `$HOME/jupyter_py3`: Defines the path for the virtual environment inside your home directory.

### Step 3: Activate the Virtual Environment
Activate the virtual environment with the following command:
<div style="background-color: black; color: white; padding: 3px; border-radius: 0px; font-family: monospace;">
<pre>
source $HOME/jupyter_py3/bin/activate
</pre>
</div>
<br>

Once activated, your shell prompt will reflect the environment's name, as shown below:
```bash
(jupyter_py3) [your_username@cluster ~]$
```

instead of <br>

```bash
[your_username@cluster ~]$
```
To deactivate the environment, simply run: `deactivate`. However, keep the environment activated for the next steps.

### Step 4: Install JupyterLab
With the virtual environment activated, install JupyterLab in it (note: it takes a few minutes).

<div style="background-color: black; color: white; padding: 3px; border-radius: 0px; font-family: monospace;">
<pre>
pip install --no-index --upgrade pip
pip install --no-index jupyterlab
</pre>
</div>

### Step 5: Create a JupyterLab Launch Script

To streamline the JupyterLab launch process, we'll create a shell script (`.sh` file). A shell script (`.sh`) is a text file containing a series of commands written for a Unix-based shell (like `Bash`). When executed, it automates tasks by running these commands sequentially, simplifying complex or repetitive operations. Execute the following command:

<div style="background-color: black; color: white; padding: 3px; border-radius: 0px; font-family: monospace;">
<pre>
echo -e '#!/bin/bash\nunset XDG_RUNTIME_DIR\njupyter lab --ip $(hostname -f) --no-browser' > $VIRTUAL_ENV/bin/jupyterlab.sh
</pre>
</div>
<br>

- `echo -e`: Enables interpretation of escape sequences (\n for newlines).
-  `#!/bin/bash`: This is called a "shebang" and tells the system to use the Bash shell to execute the script.
- `unset XDG_RUNTIME_DIR`: Resolves potential conflicts with runtime directories on remote systems.
- `jupyter lab --ip $(hostname -f) --no-browser`: Launches JupyterLab, binding it to the cluster's fully qualified domain name without opening a browser.
- The output of echo is redirected (`>`) to a new file named **jupyterlab.sh** located in the `$VIRTUAL_ENV/bin directory`.

### Step 5: Make the Script Executable
Ensure the script has executable permissions:
<div style="background-color: black; color: white; padding: 3px; border-radius: 0px; font-family: monospace;">
<pre>
chmod u+x $VIRTUAL_ENV/bin/jupyterlab.sh
</pre>
</div>
<br>
âœ… Done! The virtual environment is ready, and the JupyterLab launch script is configured. In the next section, we'll install JupyterLab and connect it to your local computer.




## Part 3: Installing Extensions

To enhance the functionality and user interface of JupyterLab, we'll install key extensions. One essential extension is **Jupyter Lmod**, which allows you to interact with environment modules directly from the JupyterLab interface. This extension leverages Lmod's Python API to handle tasks like loading, unloading, and saving module collections.

### Step 1: Install Jupyter Lmod

Ensure your virtual environment is activated. You should see the `(jupyter_py3)` prefix in your terminal prompt.

Now, load the Node.js module (required for JupyterLab extensions) and install the `jupyterlmod` package:

<div style="background-color: black; color: white; padding: 3px; border-radius: 0px; font-family: monospace;">
<pre>
module load nodejs
pip install jupyterlmod
</pre>
</div>

- `module load nodejs`: Loads the Node.js environment, necessary for building JupyterLab extensions.
- `pip install jupyterlmod`: Installs the Jupyter Lmod extension within your virtual environment.

âœ… Done! The Jupyter Lmod extension is now installed. In the next section, we'll configure JupyterLab and establish a secure connection from your local computer.



## Part 4: Using Your Environment

Now that your virtual environment is set up to run JupyterLab, this section explains how to use JupyterLab from this virtual environment on the Narval cluster.

### Step 1. Activate the Virtual Environment

Ensure that the Python virtual environment where JupyterLab is installed is activated. When logging into the cluster, you must reactivate it with:

<div style="background-color: black; color: white; padding: 3px; border-radius: 0px; font-family: monospace;">
<pre>
source $HOME/jupyter_py3/bin/activate
</pre>
</div>
<br>

To verify the environment is ready, list the installed Jupyter packages:

<div style="background-color: black; color: white; padding: 3px; border-radius: 0px; font-family: monospace;">
<pre>
pip freeze | grep jupyter
</pre>
</div>

---

### Step 2. Start JupyterLab Server

To launch a JupyterLab server, submit an interactive job using `salloc`. Adjust the parameters based on your needs, replacing `yourpi` with `licciarc-ac`:

<div style="background-color: black; color: white; padding: 3px; border-radius: 0px; font-family: monospace;">
<pre>
salloc --time=1:0:0 --ntasks=1 --cpus-per-task=2 --mem-per-cpu=1024M --account=def-yourpi srun $VIRTUAL_ENV/bin/jupyterlab.sh
</pre>
</div>

- If you need to use a GPU, add the option `--gpus-per-node=1`.

ðŸ’¡ *Wait until access to the requested resources is granted. Once approved, JupyterLab will be launched on a compute node.*

---

### Step 3. Get Hostname and Token

After launching JupyterLab, the terminal will display an output with an HTTP address like:

```
http://node_name.int.cluster.computecanada.ca:8888/lab?token=101c368829...2728fad4eb
```

From this link:

- **Hostname:Port** â†’ `node_name.int.cluster.computecanada.ca:8888`
- **Token** â†’ `101c368829...2728fad4eb`

âœ… *Write down these two pieces of information; you'll need them for the next steps.*

---

### Step 4. Connect to JupyterLab from Your Computer

Next, you'll create an SSH tunnel to access JupyterLab running on the cluster.

**For Windows Users:**  
Open a new PowerShell terminal (do not close the current one).

Replace `hostname:port` with the value you noted, `username
` with your Alliance account username, and `cluster` with the cluster name (`narval`):

<div style="background-color: black; color: white; padding: 3px; border-radius: 0px; font-family: monospace;">
<pre>
ssh -L 8888:hostname:port username@cluster.computecanada.ca
</pre>
</div>

---

### Step 5. Access JupyterLab in Your Browser

Once the tunnel is established, open your web browser and go to the following address, replacing `<token>` with your actual token:

```
http://localhost:8888/?token=<token>
```

âœ… *Real Example:*  
For example, if the hostname and token were as follows:

```
http://nc11001.narval.calcul.quebec:8888/lab?token=a49b4c3deef416e325a6dc9b14f7b6746d9379387d778392
```

- **Hostname:Port:** `nc11001.narval.calcul.quebec:8888`  
- **Token:** `a49b4c3deef416e325a6dc9b14f7b6746d9379387d778392`

Access JupyterLab via:

```
http://localhost:8888/?token=a49b4c3deef416e325a6dc9b14f7b6746d9379387d778392
```

---

ðŸŽ‰ **Done!** JupyterLab is now running on the cluster, but you can seamlessly access it from your local computer.
